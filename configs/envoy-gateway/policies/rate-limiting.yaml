apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: ai-gateway-traffic-policy
  namespace: envoy-gateway-system
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: ai-inference-gateway
  rateLimit:
    type: Global
    global:
      rules:
      # Token-based rate limiting per tenant and model
      - clientSelectors:
        - headers:
          - name: "x-tenant"
            value: "tenant-a"
          - name: "x-model"
            value: "sklearn-iris"
        limit:
          requests: 100
          unit: Minute
        metadata:
          key: "tenant-a-sklearn-iris"
          value: "token-based-limit"
      - clientSelectors:
        - headers:
          - name: "x-tenant"
            value: "tenant-b"
        limit:
          requests: 100
          unit: Minute
        metadata:
          key: "tenant-b-general"
          value: "token-based-limit"
      - clientSelectors:
        - headers:
          - name: "x-tenant"
            value: "tenant-c"
          - name: "x-model"
            value: "pytorch-resnet"
        limit:
          requests: 100
          unit: Minute
        metadata:
          key: "tenant-c-pytorch-resnet"
          value: "token-based-limit"
      # JWT-based rate limiting
      - clientSelectors:
        - headers:
          - name: "authorization"
            type: RegularExpression
            value: "Bearer .*"
        limit:
          requests: 500
          unit: Minute
        metadata:
          key: "jwt-authenticated-users"
          value: "authenticated-limit"
      # Global rate limiting with cost tracking
      - limit:
          requests: 1000
          unit: Minute
        metadata:
          key: "global-limit"
          value: "cost-0"
  circuitBreaker:
    maxConnections: 100
    maxPendingRequests: 50
    maxParallelRequests: 200
    maxParallelRetries: 10
  retry:
    numRetries: 3
    retryOn:
      httpStatusCodes:
      - 500
      - 502
      - 503
      - 504
      triggers:
      - "connect-failure"
      - "refused-stream"
  timeout:
    tcp:
      connectTimeout: 10s
    http:
      requestTimeout: 60s
      connectionIdleTimeout: 300s
      requestHeaderTimeout: 10s
      streamIdleTimeout: 30s
      maxStreamDuration: 300s
  healthCheck:
    active:
      timeout: 1s
      interval: 3s
      unhealthyThreshold: 3
      healthyThreshold: 2
      type: HTTP
      http:
        path: "/health"
        method: GET
        expectedStatuses:
        - 200
        - 201