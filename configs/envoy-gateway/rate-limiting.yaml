apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: ai-gateway-traffic-policy
  namespace: envoy-gateway-system
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: ai-inference-gateway
    namespace: envoy-gateway-system
  rateLimit:
    type: Global
    global:
      rules:
      # Per-tenant rate limiting
      - matches:
        - headers:
          - name: "x-tenant"
            value: "tenant-a"
        limit:
          requests: 100
          unit: Minute
      - matches:
        - headers:
          - name: "x-tenant"
            value: "tenant-b"
        limit:
          requests: 100
          unit: Minute
      - matches:
        - headers:
          - name: "x-tenant"
            value: "tenant-c"
        limit:
          requests: 100
          unit: Minute
      # Global rate limiting
      - limit:
          requests: 1000
          unit: Minute
  circuitBreaker:
    maxConnections: 100
    maxPendingRequests: 50
    maxRequests: 200
    maxRetries: 10
    splitExternalLocalOriginErrors: true
  retry:
    numRetries: 3
    backoffBaseInterval: 1s
    backoffMaxInterval: 10s
    retryOn:
    - "5xx"
    - "reset"
    - "connect-failure"
    - "refused-stream"
  timeout:
    tcp:
      connectTimeout: 10s
    http:
      requestTimeout: 30s
      connectionIdleTimeout: 60s
  healthCheck:
    active:
      timeout: 1s
      interval: 3s
      unhealthyThreshold: 3
      healthyThreshold: 2
      type: HTTP
      http:
        path: "/health"
        method: GET
        expectedStatuses:
        - 200
        - 201